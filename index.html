<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jevana AI - Decentralized Finance</title>
    <style>
        /* Your existing CSS styles */
    </style>
</head>
<body>
    <canvas id="binary-background"></canvas>
    <div class="container">
        <!-- Your existing HTML content -->
    </div>

    <!-- Include Solana Web3.js library via CDN -->
    <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>

    <script>
        // Binary Background
        const canvas = document.getElementById('binary-background');
        const ctx = canvas.getContext('2d');

        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const binary = ['0', '1'];
        const fontSize = 14;
        const columns = Math.floor(canvas.width / fontSize);
        const drops = new Array(columns).fill(1);

        function drawBinary() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = '#ff0000';
            ctx.font = `${fontSize}px monospace`;

            for (let i = 0; i < drops.length; i++) {
                const text = binary[Math.floor(Math.random() * binary.length)];
                ctx.fillText(text, i * fontSize, drops[i] * fontSize);

                if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                    drops[i] = 0;
                }
                drops[i]++;
            }
        }

        setInterval(drawBinary, 33);

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });

        // Eye Movement
        const eye = document.getElementById('devil-eye');
        const pupil = document.getElementById('pupil');

        document.addEventListener('mousemove', (e) => {
            const eyeRect = eye.getBoundingClientRect();
            const eyeCenterX = eyeRect.left + eyeRect.width / 2;
            const eyeCenterY = eyeRect.top + eyeRect.height / 2;

            const dx = e.clientX - eyeCenterX;
            const dy = e.clientY - eyeCenterY;

            const angle = Math.atan2(dy, dx);
            const maxDistance = (eyeRect.width - 60) / 2; // 60 is the pupil width
            const distance = Math.min(maxDistance, Math.sqrt(dx * dx + dy * dy));

            const x = Math.cos(angle) * distance;
            const y = Math.sin(angle) * distance;

            pupil.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
        });

        // Crypto Miner
        let tokens = 0;
        let clickPower = 1;
        let upgradeCost = 10;
        let withdrawableTokens = 0;
        let walletAddress = null;

        const tokenCountElement = document.getElementById('token-count');
        const miningPowerElement = document.getElementById('mining-power');
        const upgradeCostElement = document.getElementById('upgrade-cost');
        const withdrawableTokensElement = document.getElementById('withdrawable-tokens');

        function saveTokens() {
            if (walletAddress) {
                localStorage.setItem(walletAddress, JSON.stringify({ tokens, clickPower, upgradeCost }));
            }
        }

        function loadTokens() {
            if (walletAddress) {
                const savedData = localStorage.getItem(walletAddress);
                if (savedData) {
                    const data = JSON.parse(savedData);
                    tokens = data.tokens;
                    clickPower = data.clickPower;
                    upgradeCost = data.upgradeCost;
                }
            }
        }

        function updateDisplay() {
            tokenCountElement.textContent = tokens.toFixed(2);
            miningPowerElement.textContent = clickPower;
            upgradeCostElement.textContent = upgradeCost.toFixed(2);
            withdrawableTokensElement.textContent = withdrawableTokens.toFixed(2);
        }

        function checkWalletConnection() {
            if (!walletAddress) {
                alert('Please connect your Phantom wallet to perform this action.');
                return false;
            }
            return true;
        }

        document.getElementById('mine-button').addEventListener('click', () => {
            if (!checkWalletConnection()) return;
            tokens += clickPower / 10;
            saveTokens();
            updateDisplay();
        });

        document.getElementById('upgrade-button').addEventListener('click', () => {
            if (!checkWalletConnection()) return;
            if (tokens >= upgradeCost) {
                tokens -= upgradeCost;
                clickPower++;
                upgradeCost = Math.floor(upgradeCost * 1.5);
                saveTokens();
                updateDisplay();
            }
        });

        document.getElementById('withdraw-button').addEventListener('click', () => {
            if (!checkWalletConnection()) return;
            withdrawableTokens += tokens;
            tokens = 0;
            saveTokens();
            updateDisplay();
        });

        setInterval(() => {
            if (!walletAddress) return;
            tokens += clickPower / 100;
            saveTokens();
            updateDisplay();
        }, 1000);

        // Phantom Wallet Integration
        const connectWalletButton = document.getElementById('connect-wallet');
        const connectedButton = document.getElementById('connected-button');
        const disconnectButton = document.getElementById('disconnect-button');
        const walletShort = document.getElementById('wallet-short');
        const spaceShooterGameSection = document.querySelector('.space-shooter-game');
        const gameCanvas = document.getElementById('game-canvas');
        const tokensEarnedElement = document.getElementById('tokens-earned');

        let isGameRunning = false;
        let player, bullets, enemies, tokensEarned = 0;
        let disconnectTimeout;

        // Load icons with cache-busting query strings
        const playerIcon = new Image();
        playerIcon.src = 'https://www.flaticon.com/free-icon/aircraft_6141819?term=aircraft&related_id=6141819&v=1'; // Warplane icon with cache-busting

        const enemyIcon = new Image();
        enemyIcon.src = 'https://www.flaticon.com/free-icon/spaceship_5113452?term=spaceship&page=1&position=26&origin=search&related_id=5113452&v=1'; // UFO icon with cache-busting

        // Load sound effects
        const shootSound = new Audio('https://www.freesound.org/data/previews/511/511919_919539-lq.mp3'); // Replace with your shoot sound URL
        const explosionSound = new Audio('https://www.freesound.org/data/previews/512/512662_919539-lq.mp3'); // Replace with your explosion sound URL
        const backgroundMusic = new Audio('https://www.freesound.org/data/previews/512/512662_919539-lq.mp3'); // Replace with your background music URL

        // Check if the user is already connected
        const savedWalletAddress = localStorage.getItem('walletAddress');
        if (savedWalletAddress) {
            walletAddress = savedWalletAddress;
            connectWalletButton.style.display = 'none';
            connectedButton.style.display = 'inline-block';
            disconnectButton.style.display = 'inline-block';
            walletShort.textContent = savedWalletAddress.substring(0, 4);
            loadTokens();
            updateDisplay();
            spaceShooterGameSection.style.display = 'block';
            initGame();
            animate();
            startDisconnectTimer();
        }

        connectWalletButton.addEventListener('click', async () => {
            if (window.solana && window.solana.isPhantom) {
                try {
                    const resp = await window.solana.connect();
                    walletAddress = resp.publicKey.toString();
                    console.log('Connected with Public Key:', walletAddress);

                    // Save wallet address to localStorage
                    localStorage.setItem('walletAddress', walletAddress);

                    connectWalletButton.style.display = 'none';
                    connectedButton.style.display = 'inline-block';
                    disconnectButton.style.display = 'inline-block';
                    walletShort.textContent = walletAddress.substring(0, 4);

                    loadTokens();
                    updateDisplay();
                    spaceShooterGameSection.style.display = 'block';

                    initGame();
                    animate();
                    startDisconnectTimer();
                } catch (err) {
                    console.error('Error connecting to Phantom wallet:', err);
                }
            } else {
                alert('Phantom wallet not detected. Please install Phantom wallet to continue.');
            }
        });

        disconnectButton.addEventListener('click', () => {
            disconnectWallet();
        });

        function disconnectWallet() {
            localStorage.removeItem('walletAddress');
            walletAddress = null;
            connectWalletButton.style.display = 'inline-block';
            connectedButton.style.display = 'none';
            disconnectButton.style.display = 'none';
            spaceShooterGameSection.style.display = 'none';
            alert('You have been disconnected. Please connect a wallet to continue.');
        }

        function startDisconnectTimer() {
            // Clear any existing timeout
            if (disconnectTimeout) {
                clearTimeout(disconnectTimeout);
            }

            // Set a new timeout for 1 hour (3600000 milliseconds)
            disconnectTimeout = setTimeout(() => {
                disconnectWallet();
            }, 3600000); // 1 hour
        }

        // Reset the disconnect timer on user interaction
        document.addEventListener('mousedown', startDisconnectTimer);
        document.addEventListener('keydown', startDisconnectTimer);

        function initGame() {
            isGameRunning = true;
            player = { x: gameCanvas.width / 2 - 25, y: gameCanvas.height - 50, width: 50, height: 50, speed: 5 };
            bullets = [];
            enemies = [];
            tokensEarned = 0;
            tokensEarnedElement.textContent = tokensEarned;

            setInterval(() => {
                enemies.push({ x: Math.random() * (gameCanvas.width - 50), y: 0, width: 50, height: 50 });
            }, 1000);

            gameCanvas.addEventListener('click', () => {
                if (!walletAddress) {
                    alert('Please connect your Phantom wallet to play the game.');
                    return;
                }
                bullets.push({ x: player.x + player.width / 2 - 5, y: player.y, width: 10, height: 20 });
                shootSound.play();
            });

            // Track mouse movement for smooth player movement
            gameCanvas.addEventListener('mousemove', (e) => {
                const rect = gameCanvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const targetX = Math.max(0, Math.min(gameCanvas.width - player.width, mouseX - player.width / 2));

                // Smoothly move the player towards the target position
                player.x += (targetX - player.x) * 0.1;
            });

            // Play background music
            backgroundMusic.loop = true;
            backgroundMusic.play();
        }

        function animate() {
            if (!isGameRunning) return;

            const ctx = gameCanvas.getContext('2d');
            ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);

            // Draw player
            ctx.drawImage(playerIcon, player.x, player.y, player.width, player.height);

            // Draw bullets
            bullets.forEach((bullet, index) => {
                bullet.y -= 5;
                ctx.fillStyle = '#00ff00';
                ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);

                if (bullet.y < 0) {
                    bullets.splice(index, 1);
                }
            });

            // Draw enemies
            enemies.forEach((enemy, index) => {
                enemy.y += 2;
                ctx.drawImage(enemyIcon, enemy.x, enemy.y, enemy.width, enemy.height);

                if (enemy.y > gameCanvas.height) {
                    enemies.splice(index, 1);
                }

                // Check for collisions
                bullets.forEach((bullet, bulletIndex) => {
                    if (
                        bullet.x < enemy.x + enemy.width &&
                        bullet.x + bullet.width > enemy.x &&
                        bullet.y < enemy.y + enemy.height &&
                        bullet.y + bullet.height > enemy.y
                    ) {
                        bullets.splice(bulletIndex, 1);
                        enemies.splice(index, 1);
                        tokensEarned += clickPower / 10;
                        tokensEarnedElement.textContent = tokensEarned.toFixed(2);
                        explosionSound.play();

                        // Add tokens to the main balance
                        tokens += clickPower / 10;
                        saveTokens();
                        updateDisplay();
                    }
                });

                if (
                    player.x < enemy.x + enemy.width &&
                    player.x + player.width > enemy.x &&
                    player.y < enemy.y + enemy.height &&
                    player.y + player.height > enemy.y
                ) {
                    // Game Over: Reset the game without showing a popup
                    isGameRunning = false;
                    initGame(); // Restart the game
                }
            });

            requestAnimationFrame(animate);
        }

        // Check if Phantom wallet is installed
        if (typeof window.solana === 'undefined' || !window.solana.isPhantom) {
            console.warn("Phantom wallet is not installed or not detected.");
            alert("Phantom wallet is not installed or not detected. Please install Phantom wallet to continue.");
        } else {
            console.log("Phantom wallet is installed and detected.");
        }
    </script>
</body>
</html>
